{"version":3,"sources":["../src/Listener.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;;;AAEA,IAAM,mBAAmB,KAAzB;AACA,IAAM,kBAAkB,IAAxB;;IAEqB,Q;AACnB,sBAA0B;AAAA,QAAd,OAAc,yDAAJ,EAAI;AAAA;;AACxB,SAAK,GAAL,GAAW,QAAQ,GAAnB;AACA,SAAK,QAAL,GAAgB,QAAQ,QAAR,IAAoB,gBAApC;AACA,SAAK,MAAL,GAAc,uBAAa,QAAQ,IAArB,EAA2B,QAAQ,IAAnC,EAAyC,OAAzC,EAAkD,eAAlD,EAAmE,YAAM;AACrF,cAAQ,GAAR,CAAY,oCAAZ;AACD,KAFa,CAAd;AAGA,SAAK,OAAL,GAAe,uBAAf;AACD;;qBAEK,M;;;;UACE,M;;;;;;qBAAe,KAAK,MAAL,CAAY,OAAZ,E;;;AAAf,oB;;AACN,sBAAQ,GAAR,CAAY,MAAZ;;AAEA,mBAAK,GAAL,CAAS,EAAT,CAAY,aAAZ,EAA2B,gBAAoC;AAAA,oBAAzB,OAAyB,QAAjC,GAAiC,CAAzB,OAAyB;AAAA,oBAAd,OAAc,QAAd,OAAc;;AAC7D,oBAAI,OAAJ,EAAa;AACX,wBAAK,OAAL,CAAa,IAAb,CAAkB,QAAQ,KAA1B,EAAiC,OAAjC;AACD;AACF,eAJD;;AAMA,0BAAY,YAAM;AAChB,sBAAK,MAAL,CAAY,KAAZ,CAAkB,MAAK,OAAL,CAAa,OAAb,EAAlB,EACG,IADH,CACQ;AAAA,yBAAM,MAAK,OAAL,CAAa,KAAb,EAAN;AAAA,iBADR,EAEG,KAFH,CAES;AAAA,yBAAS,QAAQ,KAAR,CAAc,MAAM,KAApB,CAAT;AAAA,iBAFT;AAGD,eAJD,EAIG,KAAK,QAJR;;+CAMO,I;;;;;;;;;;;;;;;;;;;;kBA1BU,Q","file":"Listener.js","sourcesContent":["import Graphite from './Graphite';\nimport Metrics from './Metrics';\n\nconst DEFAULT_INTERVAL = 10000;\nconst DEFAULT_TIMEOUT = 5000;\n\nexport default class Listener {\n  constructor(options = {}) {\n    this.bus = options.bus;\n    this.interval = options.interval || DEFAULT_INTERVAL;\n    this.sender = new Graphite(options.host, options.port, 'UTF-8', DEFAULT_TIMEOUT, () => {\n      console.log('Graphite server connection timeout');\n    });\n    this.metrics = new Metrics();\n  }\n\n  async listen() {\n    const result = await this.sender.connect();\n    console.log(result);\n\n    this.bus.on('process:msg', ({ raw : { metrics }, process }) => {\n      if (metrics) {\n        this.metrics.push(process.pm_id, metrics);\n      }\n    });\n\n    setInterval(() => {\n      this.sender.write(this.metrics.flatten())\n        .then(() => this.metrics.empty())\n        .catch(error => console.error(error.stack));\n    }, this.interval);\n\n    return this;\n  }\n}\n"]}