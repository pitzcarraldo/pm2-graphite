{"version":3,"sources":["../src/Listener.js"],"names":[],"mappings":";;;;;;;;AAAA;;;;AACA;;;;;;AAEA,IAAM,mBAAmB,KAAzB;AACA,IAAM,kBAAkB,IAAxB;;IAEqB,Q;AACnB,sBAA0B;AAAA,QAAd,OAAc,yDAAJ,EAAI;AAAA;;AACxB,SAAK,GAAL,GAAW,QAAQ,GAAnB;AACA,SAAK,QAAL,GAAgB,QAAQ,QAAR,IAAoB,gBAApC;AACA,SAAK,MAAL,GAAc,uBAAa,QAAQ,IAArB,EAA2B,QAAQ,IAAnC,EAAyC,OAAzC,EAAkD,eAAlD,EAAmE,YAAM;AACrF,cAAQ,GAAR,CAAY,oCAAZ;AACD,KAFa,CAAd;AAGA,SAAK,MAAL,CAAY,OAAZ,CAAoB,iBAAS;AAC3B,UAAI,KAAJ,EAAW;AACT,gBAAQ,KAAR,CAAc,KAAd;AACA;AACD;AACD,cAAQ,GAAR,CAAY,8BAAZ;AACD,KAND;AAOA,SAAK,OAAL,GAAe,uBAAf;AACD;;qBAED,M,qBAAS;AAAA;;AACP,SAAK,GAAL,CAAS,EAAT,CAAY,aAAZ,EAA2B,gBAAoC;AAAA,UAAzB,OAAyB,QAAjC,GAAiC,CAAzB,OAAyB;AAAA,UAAd,OAAc,QAAd,OAAc;;AAC7D,UAAI,OAAJ,EAAa;AACX,cAAK,OAAL,CAAa,IAAb,CAAkB,QAAQ,KAA1B,EAAiC,OAAjC;AACD;AACF,KAJD;;AAMA,gBAAY,YAAM;AAChB,YAAK,MAAL,CAAY,KAAZ,CAAkB,MAAK,OAAL,CAAa,OAAb,EAAlB,EAA0C,iBAAS;AACjD,YAAI,KAAJ,EAAW;AACT,kBAAQ,KAAR,CAAc,MAAM,KAApB;AACA;AACD;AACD,cAAK,OAAL,CAAa,KAAb;AACD,OAND;AAOD,KARD,EAQG,KAAK,QARR;;AAUA,WAAO,IAAP;AACD,G;;;;;kBAnCkB,Q","file":"Listener.js","sourcesContent":["import Graphite from './Graphite';\nimport Metrics from './Metrics';\n\nconst DEFAULT_INTERVAL = 10000;\nconst DEFAULT_TIMEOUT = 5000;\n\nexport default class Listener {\n  constructor(options = {}) {\n    this.bus = options.bus;\n    this.interval = options.interval || DEFAULT_INTERVAL;\n    this.sender = new Graphite(options.host, options.port, 'UTF-8', DEFAULT_TIMEOUT, () => {\n      console.log('Graphite server connection timeout');\n    });\n    this.sender.connect(error => {\n      if (error) {\n        console.error(error);\n        return;\n      }\n      console.log('Connected to Graphite server');\n    });\n    this.metrics = new Metrics();\n  }\n\n  listen() {\n    this.bus.on('process:msg', ({ raw : { metrics }, process }) => {\n      if (metrics) {\n        this.metrics.push(process.pm_id, metrics);\n      }\n    });\n\n    setInterval(() => {\n      this.sender.write(this.metrics.flatten(), error => {\n        if (error) {\n          console.error(error.stack);\n          return;\n        }\n        this.metrics.empty();\n      });\n    }, this.interval);\n\n    return this;\n  }\n}\n"]}